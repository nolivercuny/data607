---
title: "Project 2 Unicef"
author: "Nick Oliver"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
editor_options: 
  chunk_output_type: console
---

# Project 2 - Unicef

https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/
https://childmortality.org/data

https://bbhosted.cuny.edu/webapps/discussionboard/do/message?action=list_messages&course_id=_2010109_1&nav=discussion_board_entry&conf_id=_2342994_1&forum_id=_2992508_1&message_id=_53934801_1

This dataset includes child-under-5 mortality rates for all countries from 1950 to 2015. The data is structured in wide format, where the column names include the country, and each year from 1950 to 2015. Values are the corresponding child mortality rates for that country, and that year. Restructuring this dataset into long format should be very easy to accomplish with the tidyr::gather().\

This dataset would be a great starting point for analyzing mortality rates for children under 5 over time, by country. It would also be interesting to see if any country mortality rates are correlated over time. Monitoring spikes for mortality rate over time would be a good way to identify patterns or factors leading to child mortality.

## Setup

### Load Libraries
```{r}
library(stringr)
library(dplyr)
library(tidyr)
library(kableExtra)
library(readr)
library(ggplot2)
```

### Load Data

```{r}
unicefUrl <- 'https://raw.githubusercontent.com/nolivercuny/data607/master/project2/datasets/childmortality/all_countries_dr_u5_5_9_10_14_15_24.csv'
unicefRaw <- read.csv(unicefUrl)
```

## Tidy

Grab only the relevant columns (Country, Sex, Year, Indicator, Value)

Rename them so they are easier to work with

Mutate "Year" so it's a number and drop extra data from it

Get the last year of data for each observation to make it easier to analyze. I do this with `group_by` and `slice_max` on Year. Interestingly this reveals that many indicators do not have data separated by genders. Because of this I also decided to filter out the gender specific observations and just keep the totals. 

The last step was to then make the data wider instead of longer so I could see how the mortality rate changed over time by country. I used the `pivot_wider` function to accomplish this. Unfortunately I discovered that some countries had multiple datasoruces for the Indicator per in a single year. I solved this by using the `value_fn` parameter and setting that to the mean. There are probably more nuanced ways of handling this but for my purposes this worked well enough in getting me a single value for the observation.

```{r}

beforeColon <- "^(.*?): "

unicefDf <- as.data.frame(unicefRaw) %>%
  select(c("REF_AREA.Geographic.area","INDICATOR.Indicator","SEX.Sex","TIME_PERIOD.Time.period","OBS_VALUE.Observation.Value" )) %>%
  rename(Country = "REF_AREA.Geographic.area", Indicator = "INDICATOR.Indicator", Sex = "SEX.Sex", Year = "TIME_PERIOD.Time.period", Value = "OBS_VALUE.Observation.Value") %>%
   mutate(Year = as.numeric(gsub("-.*", "", Year)), Sex = gsub(beforeColon, "", Sex),Country = gsub(beforeColon, "", Country),Indicator = gsub(beforeColon, "", Indicator)) %>% 
   filter(Sex == "Total") %>%
   group_by(Country) %>% 
   slice_max(Year) %>% 
   pivot_wider(names_from = Indicator, values_from = Value, values_fn = mean) %>%
      select(-Sex, -Year)
```

## Analysis

```{r}
kable(unicefDf,caption = "Mortality rates (deaths / 1000 births) by Country for year of 2029", format = "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")
```

```{r}
highestMortalityRate <- unicefDf %>% 
  arrange(desc(`Mortality rate 1-59 months`)) %>%
  ungroup() %>%
  top_n(10, `Mortality rate 1-59 months`)

kable(highestMortalityRate,caption = "Mortality rates (deaths / 1000 births) by Country for year of 2029", format = "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")


```

```{r}
highestMortalityRate %>% 
  pivot_longer(-Country)%>% 
  ggplot(aes(x = name, y = value, col = `Country`)) +
  geom_point() +
  geom_line()
```


```{r}
lowestMortalityRate <- unicefDf %>% 
  arrange((`Mortality rate 1-59 months`)) %>%
  ungroup() %>%
  head(10, `Mortality rate 1-59 months`)

kable(lowestMortalityRate,caption = "Mortality rates (deaths / 1000 births) by Country for year of 2029", format = "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")


```

```{r}
lowestMortalityRate %>% 
  pivot_longer(-Country)%>% 
  ggplot(aes(x = name, y = value, col = `Country`)) +
  geom_point() +
  geom_line()
```