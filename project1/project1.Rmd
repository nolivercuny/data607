---
title: "Project 1"
author: "Nick Oliver"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
editor_options: 
  chunk_output_type: console
---

# Project 1

## Load Libraries

```{r load-libraries, results=FALSE, messages=FALSE}
library(RCurl)
library(stringr)
library(dplyr)
library(tidyr)
```

## Load Raw Data

```{r read-data}
file_url <- 'https://raw.githubusercontent.com/nolivercuny/data607/master/project1/tournamentinfo.txt'
raw_data <- getURL(file_url)
```

## Processing

Get rid of useless dashes
```{r}
data <- str_replace_all(raw_data,"-", "")
```

Split the data on newlines
```{r}
split <- str_split(data, '\n', simplify = TRUE)
```
Split the data on the pipe character
```{r}
split_values <- str_split(split, '\\|', simplify=TRUE)

```
filter out empty rows
```{r}
df <- as.data.frame(split_values) %>% filter(V1 != "", V1 != "\r")
```
Break up the dataframe into two dataframes so they can be recombined because two rows represent a single record. Set the column names to the first row
```{r}
df_one <- df %>% filter(row_number() %% 2 == 1) 
names(df_one) <- df_one[1,]
df_two <- df %>% filter(row_number() %% 2 == 0)
names(df_two) <- df_two[1,]

```
Merge the two dataframes back into a single data frame. Drop the first row
```{r}
data <- bind_cols(df_one,df_two) %>% 
  subset(select=-c(11,22))
data <- data[-c(1),]
```

```{r}
data <- separate(data, 12, sep="/", into = c('USCF_ID','PRE_POST'))
data <- separate(data, 13, sep=">", into = c('Pre_Rating','Post_Rating'))

```

Remove P and values after from Pre_Rating Column
```{r}
data$Pre_Rating <- gsub("([A-Z])\\w+","",data$Pre_Rating)
```

```{r}
for (i in 1:nrow(data)){
  opponent_indexes <- extract_numeric(data[i,4:10])
  opponent_indexes<-opponent_indexes[!is.na(opponent_indexes)]
  opponents_ratings<-extract_numeric(data[opponent_indexes,13])
  rating_average <- sum(opponents_ratings) / length(opponents_ratings)
  data$Average_Opponent_Pre_Rating[i] <- round(rating_average)
}
```

```{r}
final_output <- data[,c(2,3,11,13,23)]
final_output$Pre_Rating <- gsub("R:", "", final_output$Pre_Rating)
```


```{r}
write_csv(final_output, "final_output.csv")
```